<!DOCTYPE html>
<html>
<head>
    <title>Map View</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
</head>
<body>
<script>
        let map; // グローバルに宣言
        let initialLat, initialLng; // 初期の現在地を保存する変数

        function initMap() {
            // 現在地を取得して地図を初期化する
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    initialLat = position.coords.latitude;
                    initialLng = position.coords.longitude;

                    // 地図の初期化
                    map = new google.maps.Map(document.getElementById("map"), {
                        center: { lat: initialLat, lng: initialLng },
                        zoom: 16
                    });

                    // 現在地マーカーを設定
                    new google.maps.Marker({
                        position: { lat: initialLat, lng: initialLng },
                        map: map,
                        title: "現在地"
                    });

                    // 他のアイテムデータをマッピング
                    displayItems();
                }, function() {
                    alert("現在地の取得に失敗しました。");
                });
            } else {
                alert("このブラウザは位置情報をサポートしていません。");
            }
        }

        function displayItems() {
            // Djangoのデータを取得
            const items = JSON.parse('{{ items_json|escapejs }}');
            items.forEach(item => {
                const fields = item.fields;
                if (fields.latitude && fields.longitude) {
                    const latLng = new google.maps.LatLng(fields.latitude, fields.longitude);
                    const marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: fields.description
                    });
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<img src="${fields.image_url || ''}" alt="Lost Item" style="width:100px;height:100px;"><p>${fields.description}</p><p>${fields.date_time}</p>`
                    });
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                } else {
                    console.error('Latitude or longitude data is missing for item:', fields.description);
                }
            });
        }

        function validateSearch() {
            const itemSelect = document.getElementById('item_name');
            const prefectureSelect = document.getElementById('prefecture');
            if (itemSelect.value !== '' || prefectureSelect.value !== '') {
                return true;
            } else {
                alert("品名または都道府県を選択してください。");
                return false;
            }
        }

        function performSearch() {
            if (validateSearch()) {
                console.log("初期位置:", initialLat, initialLng);
                // ここで検索処理を行う
            }
        }
    </script>

<h1>落とし物検索</h1>

<!-- 検索フォーム -->
<form method="GET" action="{% url 'search_items' %}" onsubmit="return validateSearch()">
    <label for="item_name">品名:</label>
    <input type="text" id="item_name" name="item_name">

    <label for="prefecture">都道府県:</label>
    <select id="prefecture" name="prefecture">
        <option value="">都道府県を選択</option>
        <!-- 47都道府県のリスト -->
        <option value="Hokkaido">北海道</option>
        <option value="Aomori">青森</option>
        <option value="Iwate">岩手</option>
        <option value="Miyagi">宮城</option>
        <option value="Akita">秋田</option>
        <option value="Yamagata">山形</option>
        <option value="Fukushima">福島</option>
        <option value="Ibaraki">茨城</option>
        <option value="Tochigi">栃木</option>
        <option value="Gunma">群馬</option>
        <option value="Saitama">埼玉</option>
        <option value="Chiba">千葉</option>
        <option value="Tokyo">東京</option>
        <option value="Kanagawa">神奈川</option>
        <option value="Niigata">新潟</option>
        <option value="Toyama">富山</option>
        <option value="Ishikawa">石川</option>
        <option value="Fukui">福井</option>
        <option value="Yamanashi">山梨</option>
        <option value="Nagano">長野</option>
        <option value="Gifu">岐阜</option>
        <option value="Shizuoka">静岡</option>
        <option value="Aichi">愛知</option>
        <option value="Mie">三重</option>
        <option value="Shiga">滋賀</option>
        <option value="Kyoto">京都</option>
        <option value="Osaka">大阪</option>
        <option value="Hyogo">兵庫</option>
        <option value="Nara">奈良</option>
        <option value="Wakayama">和歌山</option>
        <option value="Tottori">鳥取</option>
        <option value="Shimane">島根</option>
        <option value="Okayama">岡山</option>
        <option value="Hiroshima">広島</option>
        <option value="Yamaguchi">山口</option>
        <option value="Tokushima">徳島</option>
        <option value="Kagawa">香川</option>
        <option value="Ehime">愛媛</option>
        <option value="Kochi">高知</option>
        <option value="Fukuoka">福岡</option>
        <option value="Saga">佐賀</option>
        <option value="Nagasaki">長崎</option>
        <option value="Kumamoto">熊本</option>
        <option value="Oita">大分</option>
        <option value="Miyazaki">宮崎</option>
        <option value="Kagoshima">鹿児島</option>
        <option value="Okinawa">沖縄</option>
    </select>

    <button type="submit">検索</button>
</form>

<div id="map" style="width:100%;height:auto;"></div>
</body>
</html>