<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>マップ検索</title>

    <script src="https://maps.google.com/maps/api/js?key=AIzaSyBVf2L2W59AyS81Z6qv5fqd2JW-XjAW_pA&libraries=places&language=ja"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 80%; width: 100%; }
        #results { padding: 10px; border-top: 1px solid #ccc; overflow-y: auto; height: 200px; }
        .place-item { padding: 5px; cursor: pointer; }
        .place-item:hover { background-color: #f0f0f0; }
        .route-button { margin-top: 5px; }
    </style>
</head>

<body>
    <form method="get" action="{% url 'search' %}">
        <label for="search">検索条件</label>
        <div id="input-container">
            <select name="search-condition">
                <option value="場所" {% if search_condition == '場所' %}selected{% endif %}>場所</option>
                <option value="時間" {% if search_condition == '時間' %}selected{% endif %}>時間</option>
                <option value="特徴" {% if search_condition == '特徴' %}selected{% endif %}>特徴</option>
            </select>
            <input type="text" id="search" name="search" value="{{ search }}">
            <button type="submit" value="search_button">検索</button>
        </div>
    </form>

    <div id="map"></div>
    <div id="results"></div>

    <script>
        // 地図のオプション
        var Options = {
            zoom: 16,          // ズームレベル
            mapTypeId: 'roadmap' // 地図の種類
        };

        // 地図を表示
        var map = new google.maps.Map(document.getElementById('map'), Options);
        var infoWindow = new google.maps.InfoWindow();
        var userMarker; // 現在地マーカーを保持
        var directionsRenderer = new google.maps.DirectionsRenderer(); // DirectionsRendererをグローバルに宣言
        directionsRenderer.setMap(map); // 地図に経路を表示するための設定

        // 現在地を取得する
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var MyLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                // 地図の中心を現在地に設定
                map.setCenter(MyLatLng);

                // 現在地にマーカーを設定
                userMarker = new google.maps.Marker({
                    position: MyLatLng,
                    map: map,
                    title: 'あなたの現在地'
                });

                // 検索キーワードを取得
                var searchQuery = "{{ search|default_if_none:'' }}";
                if (searchQuery !== '') {
                    // Djangoサーバーから落とし物データを取得
                    fetch(`/get_lost_items/?search=${encodeURIComponent(searchQuery)}`)
                        .then(response => response.json())
                        .then(data => {
                            displayLostItems(data);
                        })
                        .catch(error => console.error('Error:', error));

                    function displayLostItems(items) {
                        var resultsContainer = document.getElementById('results');
                        resultsContainer.innerHTML = ''; // 既存の結果をクリア
                        items.forEach(function (item, index) {
                            var placeItem = document.createElement('div');
                            placeItem.classList.add('place-item');
                            placeItem.textContent = `${index + 1}. ${item.name}`;

                            // リスト項目をクリックしたときの処理
                            placeItem.addEventListener('click', function () {
                                var position = new google.maps.LatLng(item.lat, item.lng);
                                map.setCenter(position);
                                createMarker(item);
                            });

                            resultsContainer.appendChild(placeItem);
                            // マーカーを作成
                            createMarker(item);
                        });
                    }

                    function createMarker(item) {
                        var marker = new google.maps.Marker({
                            map: map,
                            position: new google.maps.LatLng(item.lat, item.lng),
                            title: item.name
                        });

                        // マーカーをクリックしたときに詳細情報を表示
                        google.maps.event.addListener(marker, 'click', function () {
                            var content = `
                                <div>
                                    <strong>${item.name}</strong><br>
                                    <p>${item.description}</p>
                                    <p>${item.time}</p>
                                    <button class="route-button" onclick="getRoute(${position.coords.latitude}, ${position.coords.longitude}, ${item.lat}, ${item.lng})">経路を見る</button>
                                </div>
                            `;
                            infoWindow.setContent(content);
                            infoWindow.open(map, marker);
                        });
                    }
                }
            }, function () {
                // エラーハンドリング
                handleLocationError(true, map.getCenter());
            });
        } else {
            // ブラウザが位置情報をサポートしていない場合の処理
            handleLocationError(false, map.getCenter());
        }

        // エラーハンドリング関数
        function handleLocationError(browserHasGeolocation, pos) {
            alert(browserHasGeolocation ?
                'エラー: 現在地情報を取得できませんでした。' :
                'エラー: このブラウザは位置情報をサポートしていません。');
            map.setCenter(pos);
        }

        // 経路を取得する関数
        function getRoute(startLat, startLng, endLat, endLng) {
            directionsRenderer.setMap(null);
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            var directionsService = new google.maps.DirectionsService();

            var start = new google.maps.LatLng(startLat, startLng);
            var end = new google.maps.LatLng(endLat, endLng);

            var request = {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.WALKING
            };

            directionsService.route(request, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(response);
                } else {
                    alert('経路を取得できませんでした。');
                }
            });
        }

    </script>
</body>
</html>
