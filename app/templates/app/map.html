<!DOCTYPE html>
<html>
<head>
    <title>Map View</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
</head>
<body>
<script>
    function initMap() {
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: {lat: 35.6895, lng: 139.6917}  // Tokyo center
    });

    var items = JSON.parse('{{ items_json|escapejs }}');
    items.forEach(function(item) {
        var fields = item.fields;
        if (fields.latitude && fields.longitude) {
            var latLng = new google.maps.LatLng(parseFloat(fields.latitude), parseFloat(fields.longitude));
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: fields.description
            });

            var infoWindow = new google.maps.InfoWindow({
                content: `<img src="${fields.image_url || ''}" alt="Lost Item" style="width:100px;height:100px;"><p>${fields.description}</p><p>${fields.date_time}</p>`
            });

            marker.addListener('click', function() {
                infoWindow.open(map, marker);
            });
        } else {
            console.error('Latitude or longitude data is missing for item:', fields.description);
        }
    });
}

function validateSearch() {
    var itemSelect = document.getElementById('item_name');
    var prefectureSelect = document.getElementById('prefecture');
    if (itemSelect.value !== '' || prefectureSelect.value !== '') {
        return true;
    } else {
        alert("品名または都道府県を選択してください。");
        return false;
    }
}
</script>
    <h1>落とし物検索</h1>

    <!-- 検索フォーム -->
    <form method="GET" action="{% url 'search_items' %}" onsubmit="return validateSearch()">
        <label for="item_name">品名:</label>
        <select id="item_name" name="item_name">
            <option value="">品名を選択</option>
            <option value="Credit Card">Credit Card</option>
            <option value="ID Card">ID Card</option>
            <option value="Phone">Phone</option>
            <option value="Wallet">Wallet</option>
            <option value="Key">Key</option>
        </select>

        <label for="prefecture">都道府県:</label>
        <select id="prefecture" name="prefecture">
            <option value="">都道府県を選択</option>
            <option value="Tokyo">Tokyo</option>
            <option value="Osaka">Osaka</option>
            <option value="Hokkaido">Hokkaido</option>
            <option value="Hiroshima">Hiroshima</option>
        </select>

        <button type="submit">検索</button>
    </form>
    <div id="map" style="width:100%;height:500px;"></div>
</body>
</html>